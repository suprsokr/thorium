// Copyright (c) 2025 Client Patcher
//
// Client Patcher is licensed under the MIT License.
// See the LICENSE file for details.

package patcher

// Patch represents a single memory patch
type Patch struct {
	Address uint32
	Values  []uint8
}

// PatchCategory represents a named group of patches
type PatchCategory struct {
	Name        string
	Description string
	Patches     []Patch
}

// GetClientPatches returns all available patches for the WoW 3.3.5a (12340) client.
// These are simple binary patches that don't require server-side modifications.
func GetClientPatches() []PatchCategory {
	return []PatchCategory{
		GetCustomPacketsPatches(),
		{
			Name:        "large-address-aware",
			Description: "Sets the LAA flag in PE header, allowing the 32-bit client to use up to 4GB of RAM instead of 2GB. Prevents out-of-memory crashes with heavy addons or custom content.",
			Patches: []Patch{
				{Address: 0x000126, Values: []uint8{0x23}},
			},
		},
		{
			Name:        "allow-custom-gluexml",
			Description: "Bypasses signature checks on GlueXML files (login screen UI), allowing custom login screens without MPQ signature errors.",
			Patches: []Patch{
				{Address: 0x126, Values: []uint8{0x23}},
				{Address: 0x1f41bf, Values: []uint8{0xeb}},
				{Address: 0x415a25, Values: []uint8{0xeb}},
				{Address: 0x415a3f, Values: []uint8{0x3}},
				{Address: 0x415a95, Values: []uint8{0x3}},
				{Address: 0x415b46, Values: []uint8{0xeb}},
				{Address: 0x415b5f, Values: []uint8{0xb8, 0x03}},
				{Address: 0x415b61, Values: []uint8{0x0, 0x0, 0x0, 0xeb, 0xed}},
			},
		},
		{
			// Credits: TSWoW team (tswow-scripts/util/ClientPatches.ts)
			//          https://www.wowmodding.net/files/file/283-wow-335-patcher-custom-item-fix/
			Name:        "item-dbc-disabler",
			Description: "Disables client-side Item.dbc lookups, forcing the client to request item data from the server. Enables dynamic item generation and server-side item adjustments.",
			Patches: []Patch{
				{Address: 0x168, Values: []uint8{0x5a, 0xc5, 0x75}},
				{Address: 0x11646d, Values: []uint8{0x56, 0x89, 0xe1, 0xe8, 0xdb, 0x1d, 0x24, 0x0, 0x83, 0xc4, 0x4, 0x89, 0xc6, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90}},
				{Address: 0x1164ac, Values: []uint8{0x89, 0xf1, 0x90}},
				{Address: 0x1223f7, Values: []uint8{0x56, 0x89, 0xe1, 0xe8, 0x51, 0x5e, 0x23, 0x0, 0x83, 0xc4, 0x4, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90}},
				{Address: 0x122419, Values: []uint8{0x89, 0xc7, 0x90}},
				{Address: 0x1a54ef, Values: []uint8{0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x8d, 0x4d, 0xf4}},
				{Address: 0x1a54f9, Values: []uint8{0x53, 0x2d, 0x1b}},
				{Address: 0x1a5528, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1a552c, Values: []uint8{0x45, 0xf4}},
				{Address: 0x1a572e, Values: []uint8{0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x89, 0xd9}},
				{Address: 0x1a5737, Values: []uint8{0x15, 0x2b, 0x1b}},
				{Address: 0x1a575c, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1a5760, Values: []uint8{0x4d, 0xf8}},
				{Address: 0x1a7cf5, Values: []uint8{0x83, 0xc4, 0x4, 0x56, 0x89, 0xe1, 0xe8, 0xd0, 0x4, 0x1b, 0x0, 0x83, 0xc4, 0x4, 0xeb, 0x17, 0xcc, 0x89, 0xc3, 0x89, 0xe1, 0xe8, 0x41, 0x5, 0x1b}},
				{Address: 0x1a7d0f, Values: []uint8{0x83, 0xc4, 0x4, 0xe9, 0x6b, 0x33, 0x0, 0x0, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x85, 0xc0}},
				{Address: 0x1a8c8e, Values: []uint8{0x89, 0xe1, 0xe8, 0xbb, 0xf5, 0x1a, 0x0, 0x83, 0xc4, 0x4}},
				{Address: 0x1a8c9c, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1aa6d4, Values: []uint8{0x89, 0xe1, 0xe8, 0x75, 0xdb, 0x1a, 0x0, 0x83, 0xc4, 0x4}},
				{Address: 0x1aa6e2, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1aa821, Values: []uint8{0x90, 0x8d, 0x4d, 0x8, 0xe8, 0xa6, 0xd9, 0x1a}},
				{Address: 0x1aa82a, Values: []uint8{0x8b, 0xf8, 0xe9, 0x67, 0xbe, 0x15, 0x0}},
				{Address: 0x1aa832, Values: []uint8{0xc0}},
				{Address: 0x1aa86c, Values: []uint8{0x90, 0x89, 0xf8}},
				{Address: 0x1aa8a2, Values: []uint8{0x89, 0xe1, 0xe8, 0xa7, 0xd9, 0x1a, 0x0, 0x83, 0xc4, 0x4}},
				{Address: 0x1aa8b0, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1aa9d0, Values: []uint8{0x89, 0xe1, 0xe8, 0x79, 0xd8, 0x1a, 0x0, 0x83, 0xc4, 0x4}},
				{Address: 0x1aa9de, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1aaafa, Values: []uint8{0x89, 0xe1, 0xe8, 0x4f, 0xd7, 0x1a, 0x0, 0x83, 0xc4, 0x4}},
				{Address: 0x1aab08, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x1ab076, Values: []uint8{0x89, 0xe1, 0xe8, 0x53, 0xd1, 0x1a, 0x0, 0xe9, 0x84, 0xcc, 0xff, 0xff}},
				{Address: 0x1ab083, Values: []uint8{0xc0}},
				{Address: 0x1ab0a9, Values: []uint8{0x90, 0x90, 0x85, 0xdb}},
				{Address: 0x1ab316, Values: []uint8{0x89, 0xe1, 0xe8, 0x33, 0xcf, 0x1a, 0x0, 0x83, 0xc4, 0x4}},
				{Address: 0x1ab324, Values: []uint8{0x90, 0x90, 0x90}},
				{Address: 0x306614, Values: []uint8{0x8b, 0x41, 0x8, 0x8d, 0x48, 0xc, 0xe9, 0x11, 0x1b, 0x5, 0x0}},
				{Address: 0x306620, Values: []uint8{0xeb, 0xf2, 0xcc, 0xcc, 0xcc, 0xcc}},
				{Address: 0x306650, Values: []uint8{0xeb, 0x3a, 0xcc, 0xcc, 0xcc, 0xcc}},
				{Address: 0x306683, Values: []uint8{0x8d, 0x48}},
				{Address: 0x306686, Values: []uint8{0xe9, 0x45, 0x1b, 0x5, 0x0, 0xcc, 0x8b, 0x41, 0x8, 0x8d, 0x48, 0xc, 0xe9, 0xe9, 0x1a, 0x5, 0x0, 0xcc, 0x8d, 0x4d, 0x8, 0xe8, 0xb0, 0x1b, 0x5}},
				{Address: 0x3066a0, Values: []uint8{0xe9, 0x8c, 0x41, 0xea, 0xff, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc}},
				{Address: 0x306703, Values: []uint8{0x8d, 0x48}},
				{Address: 0x306706, Values: []uint8{0xe9, 0x45, 0x1b, 0x5, 0x0, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc}},
				{Address: 0x306733, Values: []uint8{0x8d, 0x48}},
				{Address: 0x306736, Values: []uint8{0xe9, 0x15, 0x1c, 0x5, 0x0, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc}},
				{Address: 0x309e03, Values: []uint8{0x8d, 0x48}},
				{Address: 0x309e06, Values: []uint8{0xe8, 0x45, 0xe4, 0x4, 0x0, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90}},
				{Address: 0x358136, Values: []uint8{0x56, 0x8b, 0x31, 0x89, 0xf0}},
				{Address: 0x35813c, Values: []uint8{0x1, 0x99, 0x6a, 0x0, 0x68, 0x70, 0xeb, 0x5e, 0x0, 0x33, 0xc2, 0x8d, 0x4d, 0xf8, 0x51, 0x2b, 0xc2, 0x50, 0xb9, 0x28, 0xd8, 0xc5, 0x0, 0xc7, 0x45, 0xf8}},
				{Address: 0x358157, Values: []uint8{0x0, 0x0, 0x0, 0xc7, 0x45, 0xfc}},
				{Address: 0x35815e, Values: []uint8{0x0, 0x0, 0x0, 0xe8, 0xca, 0x3c, 0xf2, 0xff, 0x85, 0xc0, 0x74, 0x8}},
				{Address: 0x35816b, Values: []uint8{0x40, 0x4, 0x5e, 0x8b, 0xe5, 0x5d, 0xc3, 0x89, 0xf0, 0x5e, 0x89, 0xec, 0x5d, 0xe9, 0xa9, 0xe4, 0xfa, 0xff}},
				{Address: 0x358186, Values: []uint8{0x56, 0x8b, 0x31, 0x89, 0xf0}},
				{Address: 0x35818c, Values: []uint8{0x1, 0x99, 0x6a, 0x0, 0x68, 0x70, 0xeb, 0x5e, 0x0, 0x33, 0xc2, 0x8d, 0x4d, 0xf8, 0x51, 0x2b, 0xc2, 0x50, 0xb9, 0x28, 0xd8, 0xc5, 0x0, 0xc7, 0x45, 0xf8}},
				{Address: 0x3581a7, Values: []uint8{0x0, 0x0, 0x0, 0xc7, 0x45, 0xfc}},
				{Address: 0x3581ae, Values: []uint8{0x0, 0x0, 0x0, 0xe8, 0x7a, 0x3c, 0xf2, 0xff, 0x85, 0xc0, 0x74}},
				{Address: 0x3581bb, Values: []uint8{0x40, 0x8, 0x5e, 0x8b, 0xe5, 0x5d, 0xc3, 0x89, 0xf0, 0x5e, 0x89, 0xec, 0x5d, 0xe9, 0x89, 0xe4, 0xfa, 0xff}},
				{Address: 0x61be58, Values: []uint8{0x7c, 0x7c}},
			},
		},
	}
}

// GetAllPatchNames returns the names of all available patches
func GetAllPatchNames() []string {
	patches := GetClientPatches()
	names := make([]string, len(patches))
	for i, p := range patches {
		names[i] = p.Name
	}
	return names
}

// GetCustomPacketsPatches returns patches specifically for custom packets functionality
// These patches inject ClientExtensions.dll which provides custom packet protocol support.
// Based on TSWoW client-extensions (MIT License, Copyright (c) 2021 tswow)
// DLL source: https://github.com/tswow/tswow/tree/master/misc/client-extensions
func GetCustomPacketsPatches() PatchCategory {
	return PatchCategory{
		Name:        "custom-packets",
		Description: "Enables custom packet communication between client and server via ClientExtensions.dll injection. Allows addons to send/receive custom opcodes for extended functionality like custom UI, real-time data sync, and server-driven features.",
		Patches: []Patch{
			// Patch 1: Hook LoadLibraryA call to jump to our code cave
			// At 0x28e19c, replace LoadLibraryA call with jump to code cave
			{Address: 0x28e19c, Values: []uint8{
				0xE9, 0x19, 0x57, 0x0E, 0x00, // JMP to 0x3738b8 (our code cave)
				0x90, // pad old instruction
			}},
			
			// Patch 2: Code cave that loads both d3d9.dll and ClientExtensions.dll
			// This runs when the game tries to load d3d9.dll, loading both dlls
			{Address: 0x3738b8, Values: []uint8{
				0xEB, 0x26, // short jump 26 bytes (past code cave)
				0xFF, 0x15, 0x48, 0xF2, 0x9D, 0x00, // call "LoadLibraryA" (for d3d9.dll)
				0x60, // push all registers
				0x68, 0x71, 0x42, 0x9E, 0x00, // push "ClientExtensions.dll" string address
				0xFF, 0x15, 0x48, 0xF2, 0x9D, 0x00, // call "LoadLibraryA" (for ClientExtensions.dll)
				0x61, // pop all registers
				0xE9, 0xD0, 0xA8, 0xF1, 0xFF, // jump back
			}},
			
			// Patch 3: "ClientExtensions.dll" string in unused memory space
			// String MUST be null-terminated for LoadLibraryA to work
			{Address: 0x5e2a71, Values: []uint8{
				0x43, 0x6C, 0x69, 0x65, 0x6E, 0x74, 0x45, 0x78, 0x74, 0x65, 0x6E, 0x73, 0x69, 0x6F, 0x6E, 0x73, 0x2E, 0x64, 0x6C, 0x6C,
				0x00, // null terminator - REQUIRED for LoadLibraryA
			}},
		},
	}
}
